// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getPortsInUse = exports.getPortsFromProject = void 0;
const tslib_1 = require("tslib");
const teamsfx_api_1 = require("@microsoft/teamsfx-api");
const path = tslib_1.__importStar(require("path"));
const detect_port_1 = tslib_1.__importDefault(require("detect-port"));
const constants_1 = require("./constants");
const packageJsonHelper_1 = require("./packageJsonHelper");
const projectSettingsHelper_1 = require("./projectSettingsHelper");
const error_1 = require("../../core/error");
const telemetry_1 = require("../telemetry");
const frontendPorts = [53000];
const simpleAuthPorts = [55000];
const backendDebugPortRegex = /--inspect[\s]*=[\s"']*9229/im;
const backendDebugPorts = [9229];
const backendServicePortRegex = /--port[\s"']*7071/im;
const backendServicePorts = [7071];
const botDebugPortRegex = /--inspect[\s]*=[\s"']*9239/im;
const botDebugPorts = [9239];
const botServicePorts = [3978];
async function detectPortListening(port, logger) {
    try {
        telemetry_1.sendTelemetryEvent(telemetry_1.Component.core, telemetry_1.TelemetryEvent.DetectPortStart, { port: port.toString() });
        const race = Promise.race([
            detect_port_1.default(port),
            // in case `detectPort` hangs, set 10 seconds timeout
            new Promise((resolve) => setTimeout(() => resolve(port), 10 * 1000)),
        ]);
        const portChosen = await race;
        telemetry_1.sendTelemetryEvent(telemetry_1.Component.core, telemetry_1.TelemetryEvent.DetectPort, {
            portChosen: portChosen.toString(),
            port: port.toString(),
        });
        return portChosen !== port;
    }
    catch (error) {
        // ignore any error to not block debugging
        telemetry_1.sendTelemetryErrorEvent(telemetry_1.Component.core, telemetry_1.TelemetryEvent.DetectPort, new teamsfx_api_1.UserError({ error, source: error_1.CoreSource, name: "DetectPortError" }));
        logger === null || logger === void 0 ? void 0 : logger.warning(`Failed to detect port. ${error === null || error === void 0 ? void 0 : error.message} `);
        return false;
    }
}
async function getPortsFromProject(projectPath, projectSettings, ignoreDebugPort) {
    const ports = [];
    const includeFrontend = projectSettingsHelper_1.ProjectSettingsHelper.includeFrontend(projectSettings);
    if (includeFrontend) {
        ports.push(...frontendPorts);
        const includeSimpleAuth = projectSettingsHelper_1.ProjectSettingsHelper.includeSimpleAuth(projectSettings);
        if (includeSimpleAuth) {
            ports.push(...simpleAuthPorts);
        }
    }
    const includeBackend = projectSettingsHelper_1.ProjectSettingsHelper.includeBackend(projectSettings);
    if (includeBackend) {
        ports.push(...backendServicePorts);
        if (!(ignoreDebugPort === true)) {
            const backendDevScript = await packageJsonHelper_1.loadTeamsFxDevScript(path.join(projectPath, constants_1.FolderName.Function));
            if (backendDevScript === undefined || backendDebugPortRegex.test(backendDevScript)) {
                ports.push(...backendDebugPorts);
            }
        }
    }
    const includeBot = projectSettingsHelper_1.ProjectSettingsHelper.includeBot(projectSettings);
    if (includeBot) {
        ports.push(...botServicePorts);
        if (!(ignoreDebugPort === true)) {
            const botDevScript = await packageJsonHelper_1.loadTeamsFxDevScript(path.join(projectPath, constants_1.FolderName.Bot));
            if (botDevScript === undefined || botDebugPortRegex.test(botDevScript)) {
                ports.push(...botDebugPorts);
            }
        }
    }
    return ports;
}
exports.getPortsFromProject = getPortsFromProject;
async function getPortsInUse(ports, logger) {
    const portsInUse = [];
    for (const port of ports) {
        if (await detectPortListening(port, logger)) {
            portsInUse.push(port);
        }
    }
    return portsInUse;
}
exports.getPortsInUse = getPortsInUse;
//# sourceMappingURL=portChecker.js.map