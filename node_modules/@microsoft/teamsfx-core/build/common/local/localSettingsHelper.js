// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getProjectComponents = exports.convertToLocalEnvs = void 0;
const tslib_1 = require("tslib");
const teamsfx_api_1 = require("@microsoft/teamsfx-api");
const os = tslib_1.__importStar(require("os"));
const localSettingsConstants_1 = require("../localSettingsConstants");
const tools_1 = require("../tools");
const constants_1 = require("./constants");
const localEnvManager_1 = require("./localEnvManager");
const localEnvProvider_1 = require("./localEnvProvider");
const projectSettingsHelper_1 = require("./projectSettingsHelper");
function getAuthServiceFolder() {
    return `${os.homedir()}/.${teamsfx_api_1.ConfigFolderName}/localauth`;
}
function appendEnvWithPrefix(source, target, prefix) {
    for (const key of Object.keys(source)) {
        const prefixKey = `${prefix}${key}`;
        if (target[prefixKey] === undefined || target[prefixKey] === "") {
            // only append and do not override
            target[prefixKey] = source[key];
        }
    }
}
// Note: this may be called before `localDebug` lifecycle, so do not throw if any value is missing
// TODO: mark this as obsolete after supporting new start command.
async function convertToLocalEnvs(projectPath, projectSettings, localSettings, logger) {
    const includeFrontend = projectSettingsHelper_1.ProjectSettingsHelper.includeFrontend(projectSettings);
    const includeBackend = projectSettingsHelper_1.ProjectSettingsHelper.includeBackend(projectSettings);
    const includeBot = projectSettingsHelper_1.ProjectSettingsHelper.includeBot(projectSettings);
    const includeAAD = projectSettingsHelper_1.ProjectSettingsHelper.includeAAD(projectSettings);
    const includeSimpleAuth = projectSettingsHelper_1.ProjectSettingsHelper.includeSimpleAuth(projectSettings);
    // prepare config maps
    const authConfigs = teamsfx_api_1.ConfigMap.fromJSON(localSettings === null || localSettings === void 0 ? void 0 : localSettings.auth);
    const backendConfigs = teamsfx_api_1.ConfigMap.fromJSON(localSettings === null || localSettings === void 0 ? void 0 : localSettings.backend);
    const botConfigs = teamsfx_api_1.ConfigMap.fromJSON(localSettings === null || localSettings === void 0 ? void 0 : localSettings.bot);
    const frontendConfigs = teamsfx_api_1.ConfigMap.fromJSON(localSettings === null || localSettings === void 0 ? void 0 : localSettings.frontend);
    const teamsAppConfigs = teamsfx_api_1.ConfigMap.fromJSON(localSettings === null || localSettings === void 0 ? void 0 : localSettings.teamsApp);
    // get config for local debug
    const clientId = authConfigs === null || authConfigs === void 0 ? void 0 : authConfigs.get(localSettingsConstants_1.LocalSettingsAuthKeys.ClientId);
    const clientSecret = authConfigs === null || authConfigs === void 0 ? void 0 : authConfigs.get(localSettingsConstants_1.LocalSettingsAuthKeys.ClientSecret);
    const applicationIdUri = authConfigs === null || authConfigs === void 0 ? void 0 : authConfigs.get(localSettingsConstants_1.LocalSettingsAuthKeys.ApplicationIdUris);
    const teamsAppTenantId = teamsAppConfigs === null || teamsAppConfigs === void 0 ? void 0 : teamsAppConfigs.get(localSettingsConstants_1.LocalSettingsTeamsAppKeys.TenantId);
    const localAuthEndpoint = authConfigs === null || authConfigs === void 0 ? void 0 : authConfigs.get(localSettingsConstants_1.LocalSettingsSimpleAuthKeys.SimpleAuthServiceEndpoint);
    const localTabEndpoint = frontendConfigs === null || frontendConfigs === void 0 ? void 0 : frontendConfigs.get(localSettingsConstants_1.LocalSettingsFrontendKeys.TabEndpoint);
    const localFuncEndpoint = backendConfigs === null || backendConfigs === void 0 ? void 0 : backendConfigs.get(localSettingsConstants_1.LocalSettingsBackendKeys.FunctionEndpoint);
    const localEnvs = {};
    if (includeFrontend) {
        localEnvs[constants_1.LocalEnvFrontendKeys.Browser] = frontendConfigs === null || frontendConfigs === void 0 ? void 0 : frontendConfigs.get(localSettingsConstants_1.LocalSettingsFrontendKeys.Browser);
        localEnvs[constants_1.LocalEnvFrontendKeys.Https] = frontendConfigs === null || frontendConfigs === void 0 ? void 0 : frontendConfigs.get(localSettingsConstants_1.LocalSettingsFrontendKeys.Https);
        localEnvs[constants_1.LocalEnvFrontendKeys.Port] = "53000";
        if (includeAAD) {
            // frontend local envs
            localEnvs[constants_1.LocalEnvFrontendKeys.LoginUrl] = `${localTabEndpoint}/auth-start.html`;
            localEnvs[constants_1.LocalEnvFrontendKeys.ClientId] = clientId;
        }
        if (includeSimpleAuth) {
            // frontend local envs
            localEnvs[constants_1.LocalEnvFrontendKeys.TeamsFxEndpoint] = localAuthEndpoint;
            // auth local envs (auth is only required by frontend)
            localEnvs[constants_1.LocalEnvAuthKeys.Urls] = localAuthEndpoint;
            localEnvs[constants_1.LocalEnvAuthKeys.ClientId] = clientId;
            localEnvs[constants_1.LocalEnvAuthKeys.ClientSecret] = clientSecret;
            localEnvs[constants_1.LocalEnvAuthKeys.IdentifierUri] = applicationIdUri;
            localEnvs[constants_1.LocalEnvAuthKeys.AadMetadataAddress] = `https://login.microsoftonline.com/${teamsAppTenantId}/v2.0/.well-known/openid-configuration`;
            localEnvs[constants_1.LocalEnvAuthKeys.OauthAuthority] = `https://login.microsoftonline.com/${teamsAppTenantId}`;
            localEnvs[constants_1.LocalEnvAuthKeys.TabEndpoint] = localTabEndpoint;
            localEnvs[constants_1.LocalEnvAuthKeys.AllowedAppIds] = tools_1.getAllowedAppIds().join(";");
            localEnvs[constants_1.LocalEnvAuthKeys.ServicePath] = getAuthServiceFolder();
        }
        if (includeBackend) {
            localEnvs[constants_1.LocalEnvFrontendKeys.FuncEndpoint] = localFuncEndpoint;
            localEnvs[constants_1.LocalEnvFrontendKeys.FuncName] = projectSettings === null || projectSettings === void 0 ? void 0 : projectSettings.defaultFunctionName;
            localEnvs[constants_1.LocalEnvBackendKeys.FuncWorkerRuntime] = "node";
            // function local envs
            localEnvs[constants_1.LocalEnvBackendKeys.ClientId] = clientId;
            localEnvs[constants_1.LocalEnvBackendKeys.ClientSecret] = clientSecret;
            localEnvs[constants_1.LocalEnvBackendKeys.AuthorityHost] = "https://login.microsoftonline.com";
            localEnvs[constants_1.LocalEnvBackendKeys.TenantId] = teamsAppTenantId;
            localEnvs[constants_1.LocalEnvBackendKeys.ApiEndpoint] = localFuncEndpoint;
            localEnvs[constants_1.LocalEnvBackendKeys.ApplicationIdUri] = applicationIdUri;
            localEnvs[constants_1.LocalEnvBackendKeys.AllowedAppIds] = tools_1.getAllowedAppIds().join(";");
        }
        localEnvs[constants_1.LocalEnvCertKeys.SslCrtFile] = frontendConfigs === null || frontendConfigs === void 0 ? void 0 : frontendConfigs.get(localSettingsConstants_1.LocalSettingsFrontendKeys.SslCertFile);
        localEnvs[constants_1.LocalEnvCertKeys.SslKeyFile] = frontendConfigs === null || frontendConfigs === void 0 ? void 0 : frontendConfigs.get(localSettingsConstants_1.LocalSettingsFrontendKeys.SslKeyFile);
    }
    if (includeBot) {
        // bot local env
        localEnvs[constants_1.LocalEnvBotKeys.BotId] = botConfigs === null || botConfigs === void 0 ? void 0 : botConfigs.get(localSettingsConstants_1.LocalSettingsBotKeys.BotId);
        localEnvs[constants_1.LocalEnvBotKeys.BotPassword] = botConfigs === null || botConfigs === void 0 ? void 0 : botConfigs.get(localSettingsConstants_1.LocalSettingsBotKeys.BotPassword);
        localEnvs[constants_1.LocalEnvBotKeys.ClientId] = clientId;
        localEnvs[constants_1.LocalEnvBotKeys.ClientSecret] = clientSecret;
        localEnvs[constants_1.LocalEnvBotKeys.TenantID] = teamsAppTenantId;
        localEnvs[constants_1.LocalEnvBotKeys.OauthAuthority] = "https://login.microsoftonline.com";
        localEnvs[constants_1.LocalEnvBotKeys.LoginEndpoint] = `${botConfigs === null || botConfigs === void 0 ? void 0 : botConfigs.get(localSettingsConstants_1.LocalSettingsBotKeys.BotEndpoint)}/auth-start.html`;
        localEnvs[constants_1.LocalEnvBotKeys.ApplicationIdUri] = applicationIdUri;
        if (includeBackend) {
            localEnvs[constants_1.LocalEnvBackendKeys.ApiEndpoint] = localFuncEndpoint;
        }
    }
    // TODO: This is to load .env.teamsfx.local for each component. Remove this after fully supporting custom local debug.
    try {
        const localEnvProvider = new localEnvProvider_1.LocalEnvProvider(projectPath);
        if (includeFrontend) {
            const customEnvs = (await localEnvProvider.loadFrontendLocalEnvs(includeBackend, includeAAD))
                .customizedLocalEnvs;
            appendEnvWithPrefix(customEnvs, localEnvs, "FRONTEND_");
        }
        if (includeBackend) {
            const customEnvs = (await localEnvProvider.loadBackendLocalEnvs()).customizedLocalEnvs;
            appendEnvWithPrefix(customEnvs, localEnvs, "BACKEND_");
        }
        if (includeBot) {
            const customEnvs = (await localEnvProvider.loadBotLocalEnvs()).customizedLocalEnvs;
            appendEnvWithPrefix(customEnvs, localEnvs, "BOT_");
        }
    }
    catch (error) {
        logger === null || logger === void 0 ? void 0 : logger.error(`Cannot load .env.teamsfx.local. ${error}`);
    }
    return localEnvs;
}
exports.convertToLocalEnvs = convertToLocalEnvs;
// for telemetry use only
// Used by VSC, CLI & VS
async function getProjectComponents(projectPath, logger, telemetry) {
    const localEnvManager = new localEnvManager_1.LocalEnvManager(logger, telemetry);
    try {
        const projectSettings = await localEnvManager.getProjectSettings(projectPath);
        const result = { components: [] };
        if (projectSettingsHelper_1.ProjectSettingsHelper.isSpfx(projectSettings)) {
            result.components.push("spfx");
        }
        if (projectSettingsHelper_1.ProjectSettingsHelper.includeFrontend(projectSettings)) {
            result.components.push("frontend");
        }
        if (projectSettingsHelper_1.ProjectSettingsHelper.includeBot(projectSettings)) {
            result.components.push(`bot`);
            result.botHostType = projectSettingsHelper_1.ProjectSettingsHelper.includeFuncHostedBot(projectSettings)
                ? "azure-functions"
                : "app-service";
            result.botCapabilities = projectSettingsHelper_1.ProjectSettingsHelper.getBotCapabilities(projectSettings);
        }
        if (projectSettingsHelper_1.ProjectSettingsHelper.includeBackend(projectSettings)) {
            result.components.push("backend");
        }
        if (projectSettingsHelper_1.ProjectSettingsHelper.includeAAD(projectSettings)) {
            result.components.push("aad");
        }
        return JSON.stringify(result);
    }
    catch (error) {
        return undefined;
    }
}
exports.getProjectComponents = getProjectComponents;
//# sourceMappingURL=localSettingsHelper.js.map